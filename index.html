<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Serwerów Minecraft</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteka Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { background-color: #111827; color: #d1d5db; }
        .server-card { transition: all 0.2s ease-in-out; background-color: #1f2937; }
        .server-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .btn { transition: background-color 0.2s; }
        .status-badge { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 9999px; font-weight: 600; text-transform: uppercase; }
        .status-Uruchomiony { background-color: #10b981; color: white; }
        .status-Zatrzymany { background-color: #6b7280; color: white; }
        .status-Błąd { background-color: #ef4444; color: white; }
        .status-Uruchamianie { background-color: #f59e0b; color: white; }
        /* Style dla okna konsoli */
        #console-modal { display: none; }
        #console-output {
            height: 60vh;
            background-color: #000;
            color: #e5e7eb;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
            overflow-y: scroll;
            border: 1px solid #4b5563;
        }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Panel Zarządzania Serwerami Minecraft</h1>
        </header>
        <main id="server-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Karty serwerów -->
        </main>
    </div>

    <!-- Szablon karty serwera -->
    <template id="server-card-template">
        <div class="server-card rounded-lg shadow-md p-5 flex flex-col justify-between">
            <div>
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-xl font-bold text-white" data-name>Nazwa Serwera</h2>
                    <span class="status-badge" data-status>Status</span>
                </div>
                <p class="text-sm text-gray-500 mb-4">Auto-restart: <span data-autorestart></span></p>
            </div>
            <div class="flex flex-wrap gap-2 mt-auto">
                <button data-action="start" class="btn flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50">Uruchom</button>
                <button data-action="stop" class="btn flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50">Zatrzymaj</button>
                <button data-action="console" class="btn flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded disabled:opacity-50">Konsola</button>
            </div>
        </div>
    </template>

    <!-- Okno modalne konsoli -->
    <div id="console-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h3 class="text-lg font-bold text-white" id="console-title">Konsola</h3>
                <button id="close-console" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="p-4">
                <div id="console-output" class="p-2 rounded-md mb-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="console-input" class="flex-grow bg-gray-900 text-white p-2 rounded-md border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Wpisz komendę...">
                    <button id="send-command" class="btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Wyślij</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicjalizacja Socket.IO
        const socket = io();

        // Elementy DOM
        const serverList = document.getElementById('server-list');
        const template = document.getElementById('server-card-template');
        const consoleModal = document.getElementById('console-modal');
        const consoleTitle = document.getElementById('console-title');
        const consoleOutput = document.getElementById('console-output');
        const consoleInput = document.getElementById('console-input');
        const sendCommandBtn = document.getElementById('send-command');
        const closeConsoleBtn = document.getElementById('close-console');
        
        let activeConsoleServer = null;

        // --- Logika WebSocket ---
        socket.on('connect', () => console.log('Połączono z serwerem WebSocket.'));
        socket.on('console_output', (msg) => {
            if (msg.server === activeConsoleServer) {
                const line = document.createElement('div');
                line.textContent = msg.data;
                consoleOutput.appendChild(line);
                // Automatyczne przewijanie
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        });

        // --- Funkcje pomocnicze ---
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error('Błąd serwera');
                return await response.json();
            } catch (error) {
                console.error('Błąd API:', error);
            }
        }
        
        function renderServers(servers) {
            serverList.innerHTML = '';
            servers.forEach(server => {
                const card = template.content.cloneNode(true);
                const nameEl = card.querySelector('[data-name]');
                const statusEl = card.querySelector('[data-status]');
                const autorestartEl = card.querySelector('[data-autorestart]');
                const startBtn = card.querySelector('[data-action="start"]');
                const stopBtn = card.querySelector('[data-action="stop"]');
                const consoleBtn = card.querySelector('[data-action="console"]');

                nameEl.textContent = server.name;
                statusEl.textContent = server.status;
                statusEl.className = `status-badge status-${server.status.replace(/\s/g, '')}`;
                autorestartEl.textContent = server.auto_restart ? 'Włączony' : 'Wyłączony';
                
                const isRunning = server.status === 'Uruchomiony';
                startBtn.disabled = isRunning || server.status === 'Uruchamianie';
                stopBtn.disabled = !isRunning;
                consoleBtn.disabled = !isRunning;

                startBtn.addEventListener('click', () => handleAction(server.name, 'start'));
                stopBtn.addEventListener('click', () => handleAction(server.name, 'stop'));
                consoleBtn.addEventListener('click', () => openConsole(server.name));

                serverList.appendChild(card);
            });
        }

        async function handleAction(serverName, action) {
            await apiCall(`/api/servers/${serverName}/${action}`, { method: 'POST' });
            fetchServers();
        }

        function openConsole(serverName) {
            activeConsoleServer = serverName;
            consoleTitle.textContent = `Konsola: ${serverName}`;
            consoleOutput.innerHTML = ''; // Wyczyść konsolę
            consoleModal.style.display = 'flex';
            consoleInput.focus();
        }

        function closeConsole() {
            consoleModal.style.display = 'none';
            activeConsoleServer = null;
        }

        function sendCommand() {
            const command = consoleInput.value;
            if (command && activeConsoleServer) {
                socket.emit('send_command', { server: activeConsoleServer, command: command });
                consoleInput.value = '';
            }
        }

        async function fetchServers() {
            const data = await apiCall('/api/servers');
            if (data) renderServers(data);
        }

        // Event Listeners
        closeConsoleBtn.addEventListener('click', closeConsole);
        sendCommandBtn.addEventListener('click', sendCommand);
        consoleInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendCommand();
        });

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', () => {
            fetchServers();
            setInterval(fetchServers, 3000);
        });
    </script>
</body>
</html>
